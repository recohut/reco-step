
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>How to build a product recommender</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="product-recommender-s3-postgres"
                  title="How to build a product recommender"
                  environment="web"
                  feedback-link="https://github.com/recohut/reco-step/issues">
    
      <google-codelab-step label="Introduction" duration="5">
        <p>We will create a simple end-to-end product recommendation system for similar products simply with historical sales data.</p>
<h2 is-upgraded>What you&#39;ll learn?</h2>
<ol type="1">
<li>Build a co-occurence matrix in python</li>
<li>Identify similar items with cosine similarity</li>
</ol>
<h2 is-upgraded>Why is this important?</h2>
<ul>
<li>Simplicity matters! Sometimes simple models beats state of the art AI models in production</li>
</ul>
<h2 is-upgraded>How it will work?</h2>
<ol type="1">
<li>Create a sample dataset</li>
<li>Build co-occurence matrix</li>
<li>Build cosine similarity table</li>
<li>Offline model validation</li>
<li>Generate JSON of top-k recommendations</li>
<li>Store the JSON into S3 bucket</li>
</ol>
<p>Developers will be able to fetch the JSON into Postgres database. This Postgres database can then be used to serve products on the front end.</p>
<h2 is-upgraded>Who is this for?</h2>
<ul>
<li>People who are looking to build a simple retail recommender system and deploy it on cloud</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Build the dataset" duration="5">
        <p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-how-to-build-a-product-recommender-untitled.png" src="img/dae713ae99db934a.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Build co-occurrence matrix" duration="5">
        <pre><code language="language-python" class="language-python">import pandas as pd
import numpy as np
import s3fs
import json
from sklearn.metrics.pairwise import cosine_similarity
import datetime

pivot_df = pd.pivot_table(sales_df,index = &#39;order_id&#39;,columns = &#39;product_id&#39;,values = &#39;category&#39;,aggfunc = &#39;count&#39;)
pivot_df.reset_index(inplace=True)
pivot_df = pivot_df.fillna(0)
pivot_df = pivot_df.drop(&#39;order_id&#39;, axis=1)

co_matrix = pivot_df.T.dot(pivot_df)
np.fill_diagonal(co_matrix.values, 0)
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Build cosine similarity table" duration="5">
        <pre><code language="language-python" class="language-python">cos_score_df = pd.DataFrame(cosine_similarity(co_matrix))
cos_score_df.index = co_matrix.index
cos_score_df.columns = np.array(co_matrix.index)
</code></pre>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-how-to-build-a-product-recommender-untitled-1.png" src="img/ac877794b7b96c21.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Offline model validation" duration="2">
        <p>As with most unsupervised learning models, model validation can be tricky. For our dataset we have a diverse set of product categories. Since we are creating a recommender to show similar products we should expect our model to return recommendations that are in the same category as the original base product.</p>
<p><em>For Each Product Category: </em></p>
<p><strong><em>Count(Best Recommendation for Each Product in Category)/ Count(Products in Category) = % of Recommendations in Same Category</em></strong></p>
<p>From here model validation would continue once we promote the first version of our model to production and commence with an AB test. Some parameter tuning considerations as you iterate your model would be having a cosine similarity score threshold or sample size threshold to limit recommendations to ones where we have the highest confidence.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Generate JSON of top-k recommendations" duration="5">
        <pre><code language="language-bash" class="language-bash">#Take top five scoring recs that aren&#39;t the original product
product_recs = []
for i in cos_score_df.index:
    product_recs.append(cos_score_df[cos_score_df.index!=i][i].sort_values(ascending = False)[0:5].index)
    
product_recs_df = pd.DataFrame(product_recs)
product_recs_df[&#39;recs_list&#39;] = product_recs_df.values.tolist()
product_recs_df.index = cos_score_df.index
#Semi-colon delimited JSON Output
product_recs_df[&#39;json_out&#39;] = product_recs_df[&#39;recs_list&#39;].apply(lambda x: [str(element) for element in x])
product_recs_df[&#39;json_out&#39;] = product_recs_df[&#39;json_out&#39;].apply(lambda x: &#34;;&#34;.join(x))
product_recs_dict = product_recs_df.to_dict()
json_out = json.dumps(product_recs_dict[&#39;json_out&#39;],indent = 4,ensure_ascii = False).encode(&#39;UTF-8&#39;)
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Store the JSON into an S3 bucket" duration="5">
        <pre><code language="language-bash" class="language-bash">ts = datetime.datetime.now().strftime(&#34;%Y-%m-%d_%H-%M&#34;)
fs = s3fs.S3FileSystem(key=s3_key, secret=s3_value)
with fs.open(&#39;s3://yourbucket/key&#39;+ts+&#39;.json&#39;, &#39;wb&#39;) as f:
    f.write(bytes(json_out))
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion" duration="2">
        <p>Congratulations!</p>
<p>With all models the quality of your model outputs will be dependent on the quality of your data. Typically the larger sample of orders we have for each product the better; as we would expect to reduce the noise from random product co-occurrences at larger sample sizes. To find the right sample size threshold for your model you can evaluate the model validation metric (% of Recommendations in Same Category) at different sample thresholds to see at which threshold you start seeing a meaningful drop off in the evaluation metric.</p>
<h2 is-upgraded>Have a Question?</h2>
<ul>
<li><a href="https://form.jotform.com/211377288388469" target="_blank">Fill out this form</a></li>
<li><a href="https://github.com/recohut/reco-step/issues" target="_blank">Raise issue on Github</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
