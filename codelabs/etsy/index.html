
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Etsy</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="etsy"
                  title="Etsy"
                  environment="web"
                  feedback-link="https://github.com/recohut/reco-step/issues">
    
      <google-codelab-step label="Introduction" duration="5">
        <p>Two-sided marketplaces such as eBay, Etsy and Taobao have two distinct groups of customers: buyers who use the platform to seek the most relevant and interesting item to purchase and sellers who view the same platform as a tool to reach out to their audience and grow their business. Additionally, platforms have their own objectives ranging from growing both buyer and seller user bases to revenue maximization. It is not difficult to see that it would be challenging to obtain a globally favorable outcome for all parties. Taking the search experience as an example, any interventions are likely to impact either buyers or sellers unfairly to course correct for a greater perceived need.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled.png" src="img/415e429132e5f1f7.png"></p>
<p>Etsy is a two-sided online marketplace with over 50 million handmade and vintage items where sellers sell handmade items, and where buyers go to purchase personalized handmade items. One feature of Etsy, is that it provides personalized item recommendations to buyers based on their previous interactions on the site. For Etsy, users come to rely on personalized recommendations to surface relevant items from its massive inventory. One hallmark of Etsy&#39;s shopping experience is the multitude of ways in which a user can interact with an item they are interested in: they can view it, favorite it, add it to a collection, add it to cart, purchase it, etc.</p>
<p>Implicit feedback includes all of a users interactions on a site including the items that they purchased, items that they favorited, items that they clicked on and even items that they saw but made no interaction with.</p>
<p>Etsy wanted to use this kind of information in combination with user and listing features to train their machine learning models and predict the probability of purchase as their recommender system. With these probabilities of purchase, they could also use it to infer how new users might make purchases.</p>


      </google-codelab-step>
    
      <google-codelab-step label="LDA model" duration="5">
        <p>Etsy use <a href="https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation" target="_blank">Latent Dirichlet Allocation</a> to generate style profiles for all items and builds a distribution for each user amongst the style profile. Aryafar says that ‘LDA essentially gives you these style profiles and it also gives you the distribution of users preference in terms of these style profiles&#39;. These distributions then allow users to be positioned near users who have a similar style profiles to serve recommendations.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-1.png" src="img/1df941848604fad1.png"></p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-2.png" src="img/3d0fb15b808f9903.png"></p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-3.png" src="img/7c26a75dd2fd7ce1.png"></p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-4.png" src="img/bde25cc2f060feb0.png"></p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-5.png" src="img/94c5cc31407d264a.png"></p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-6.png" src="img/ddd556c0a4007d44.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Multi-stage model" duration="10">
        <p>A problem that Etsy faced is that they had too many users and too many product listings to compute all of these purchase probabilities. Therefore, they did it in a two stage process: 1) &#34;Candidate Selection&#34; in which millions of listings are filtered down to hundreds of relevant items and 2) &#34;Ranker&#34; in which those items are then ranked based on relevance using more precision.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-7.png" src="img/4618f1f4cec6e4e2.png"></p>
<p>Originally, the second stage &#34;Ranker&#34; used a linear model, but more recently there has been experimentation using non-linear models and deep neural networks (DNNs); a DNN is better in this case because it provides a better fit of the model. After experimentation, it was found that a 3-layer neural network was optimal for predicting the likelihood of purchase.</p>
<h2 is-upgraded>Item-interaction embeddings</h2>
<p>Etsy&#39;s proposed model is based on word2vec, a popular method in natural language processing (NLP) for learning a semi-supervised model to discover semantic similarity across words in a corpus using an unlabelled body of text. The same method can be used to model user interactions at Etsy by modeling users&#39; journeys in aggregate as a sequence of user engagements on listings, i.e., viewed, favored, add-to-carted or purchased. Each user session is analogous to a sentence, and each user action is analogous to a word in NLP word2vec parlance. This method of modeling interactions allows us to represent items or other entities (i.e., shops, users, queries) as low dimensional continuous vectors, where the similarity across two different vectors represents their co-relatedness. Semantic embeddings are agnostic to the content of items such as their titles, tags, descriptions, and allow us to leverage aggregate user interactions on the site to extract items that are semantically similar.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-8.png" src="img/72f6b491f3de3384.png"></p>
<p>Let L denote the set of items and I the set of interaction types a user can have with an item (e.g., view, favorite, add-to-cart, purchase). Each user&#39;s visit on Etsy triggers a session S = {p1, ... ,pk }, which consists of a sequence of item-interaction pairs pj ∈ L × I. For example, the sequence (ℓ1, view), (ℓ2, favorite), (ℓ1, purchase) specifies that a user first viewed item ℓ1, then favorited item ℓ2, and lastly purchased item ℓ1. The training data consists of such sequences collected from multiple users over a set period of time.</p>
<h2 is-upgraded>Candidate set selection</h2>
<p>A crucial task for industry-scale recommendation systems is its ability to quickly retrieve a small set of relevant items out of a large set (potentially in the range of hundreds of millions) of candidate items. This is necessary as it is computationally infeasible to apply machine-learned models over the entire collection of candidate items. In practice, this is referred to as the candidate set selection phase, which aims to quickly prune irrelevant items while retrieving items that are likely to be relevant to the user at low cost. The smaller set is then re-ranked by a (typically, more sophisticated) machine learning model.</p>
<p>While candidate set selection has always been an important component of large-scale recommendation systems, it is often overlooked in favor of discussing the machine learned re-ranking model. Many previous works depend on basic heuristics that measure goodness of match between the user and items based on product category or taxonomy matching schemes, or simple popularity rankings. Beyond basic heuristics, co-occurring signals have been a popular method for simple and efficient candidate set selection. Amazon tracks pairs of items that are frequently co-purchased by the same customers and constructs candidate sets by retrieving items that have been frequently co-purchased with a customer&#39;s last viewed items. Pinterest&#39;s related pin recommendations system selects candidate pins based on board co-occurrence, the number of times a pin has been pinned to the same board. Other candidate set models include variations on the random walk, as well as collaborative filtering or deep network approaches that incorporate user&#39;s historical interactions. Another class of algorithms come from IR, utilizing fast query-document retrieval engines to match user and item features.</p>
<p>While these methods are undoubtedly successful, Etsy&#39;s candidate set selection method explicitly considers the target item to generate candidate sets based on interaction type. This method can be seen as a generalization of using co-occurrence counts, a popular approach for candidate set selection in the past. The underlying concept there assumes that if a pair of items has been viewed or purchased together within a short amount of time by the same user, there&#39;s a good chance the two items are related. However, this method does not consider the different ways in which a customer can interact with items, usually focusing only on co-purchases, and requires items to have been explicitly co-purchased together, leading to low coverage. Etsy&#39;s proposed method is more flexible and generalizes beyond explicit co-occurrence counts, with the ability to give recommendations along the lines of &#34;Because you X this, you may also want to Y that&#34;, where X and Y are any interaction types.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-9.png" src="img/260d6254838c41db.png"></p>
<p>Example of the item-interaction pair embedding space. Given a user&#39;s last action (e.g. viewed listing ℓ1), the top K nearest neighbors should indicate which item the user is likely to interact with, as well as how the user will interact with it (e.g. the user may view items ℓ4 or ℓ5; cart items ℓ1 or ℓ2; or purchase item ℓ3).</p>
<p>The learned embeddings described above now give us a convenient way of encoding co-occurrence patterns between items and the way users interact with them. A nice property is that the inner product between two such embeddings should approximate the likelihood that one item-interaction pair would co-occur with another. Because of its computational efficiency, it is easy to approximate the affinity between tens of millions of pairs of embedding vectors, lending itself naturally as a candidate set selection solution. For example, to answer a question such as &#34;since a user viewed on item A, what is an item they may add to cart next?&#34;, we can simply find the nearest &#34;cart&#34; embedding to item A&#39;s &#34;view&#34; embedding. A user-specific candidate set can then be generated by finding the closest listings to each of the user&#39;s past item-interaction pairs in the embedded space.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Dataset" duration="2">
        <p>The training data spans a one year period of visit log collected from Nov 2017 to Oct 2018, and is extracted from implicit feedback collected from users visiting Etsy during that period. In particular, each training instance is defined by a user&#39;s session and consisted of a sequence of item-interaction pairs sorted chronologically.</p>
<p>Only sessions which had more than three item-interaction pairs were selected, to eliminate bounces. The resulting dataset has about 30 billion words from over 200 millions distinct tokens.</p>
<h2 is-upgraded>Negative Sampling</h2>
<p>The proposed model uses the negative sampling to facilitate computational efficiency in model training and improve the quality of the low-dimensional vector representations. As the initial step in the implementation of negative sampling, they define the following partial order on the set of interactions we consider: purchase &gt; add-to-cart &gt; favorite &gt; view. For each item-interaction pair p = (ℓ,i) of a given session S, they add negative samples pj = (ℓ, j), for all interactions j &gt; i, provided that the pair pj &lt; S. For example, if an item has been viewed and added-to-cart, we associate with it a negative purchase. A natural drawback of this approach is that it precludes the addition of negative samples having view as an interaction. To account for this, we include two negative pairs (ℓ1, view), (ℓ2, view), for each item ℓ that was only viewed. The items ℓ1, ℓ2 are drawn uniformly at random from the set of items belonging to the same taxonomy as ℓ in order to capture the user&#39;s preference in the item viewed in said taxonomy.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Implementation" duration="2">
        <p>In order to support custom negative sampling, Etsy used the fastText library to train the embedding models with extended functionalities built on top of the existing library. The primary innovation from fastText is that it enriches the word2vec model with subword information by adding a bag of character ngrams. They experimented with tuning several hyperparameters of the model and eventually chose to set the context window to m = 5 and the embedding dimension to d = 100.</p>
<p>To help avoid the computational workload from serving recommendation from enormous matrices for each of the more than 50 million users, Etsy use <a href="https://en.wikipedia.org/wiki/Locality-sensitive_hashing" target="_blank">locality sensitive hashing</a> to pool similar items into buckets which assumes that users will fall into the same bucket if they have similar tastes. Team added five random negative samples in each of our sequences. After training, they use the approximate K-nearest neighbor search algorithm, Hierarchical Navigable Small World from Faiss (HNSW), in order to get the top k similar items for each learned iteminteraction pair.</p>
<p>To balance efficiency with accuracy, they set the following hyperparameters in HNSW (efSearch = 256, efConstruction = 128, linksPerVector = 64) to scale up the approximated neighborhood search over hundreds of millions item-interaction pairs from embedding training.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Multi-objective optimization" duration="2">
        <p>Once Etsy developed their recommender system for relevant items, they than wanted to see if they could optimize for both relevance and profit at the same time. So, instead of only showing users relevant items, or showing them items priced from highest to lowest, they wanted to find an optimum where they could show a relevant item while not compromising on revenue. Therefore, they introduced a revenue term into their model, and were successful at optimizing for revenue without compromising on relevance.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-10.png" src="img/25582bb875e140ed.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Offline evaluation" duration="2">
        <p>When it came to evaluating the model, metrics used included Area under the Curve (AUC) for relevance, Normalized Discounted Cumulative Gain (NDCG) used for ranking in terms of both relevance and price and then price based metrics like Profit.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-11.png" src="img/85796df932dae925.png"></p>
<p>When compared against linear regression, and logistic and weighted logistic regressions for baseline performance, the new revenue-relevance model was in fact able to attain the highest Profit and AUC metrics among these.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-12.png" src="img/9182ad05e81cad44.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Online evaluation" duration="2">
        <p>The value of having a data science team for recommender systems at Etsy is tangible through comprehensive A/B testing. In the following figures, we can see a visual examples of the recommendations received by users in the two buckets of live A/B test on the homepage on etsy.com. The test was run for 7 days in which bucketed 50% of signed-in users into the control group, and the remainder into the treatment group. The control group received a single module that recommends items using a candidate set that matched items based on the last 100 items that the user interacted with, regardless of the interaction type. The treatment group received two separate modules: The first module finds the closest item-interaction embeddings based on the last 4 items that the user had viewed; the second module is computed similarly but is based on the last 4 items that the user has added to cart. This treatment group option was preferred as it offers more explainability to the user.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-13.png" src="img/9f68ca1798a9b265.png"></p>
<p>Control group</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-14.png" src="img/afa24fcdbcfb9dcc.png"></p>
<p>Treatment group</p>
<p>Both the control and treatment groups used the same re-ranking model on top of the candidate set selection phase, which has an objective function that is optimized for predicting purchases, and uses a variety of historical user and listing rates and content features. While the team prepared additional modules based on favoriting and purchasing behavior, they were not deployed to the live A/B test due to their lower-than-desired offline metrics.</p>
<p>For this particular experiment, the metrics that were tracked include site-wide click-through-rate, conversion rate, and add-tocart rate. Given the preliminary experimental data, team observed promising upward trend in many key metrics, although more data is needed to gain statistical significance. Compared to the control, the first module in the treatment (&#34;Inspired by what you&#39;ve viewed&#34;) showed 4.1% improvement in click-through-rate. Additionally, the &#34;treatment&#34; group showed 0.20% and 0.31.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Personalized search re-ranking" duration="5">
        <p>With a large pool of candidate listings, personalized search is an important tool to help users find items that best fit their preferences. Head queries account for the lion&#39;s share of purchases from the site. Many of these queries are vague, short in length, and have a myriad of search results. As an example, in 2020 the top searched query on Etsy was &#34;personalized gifts&#34;, which had over 5 million search results.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-15.png" src="img/e2c052cdee6e67d0.png"></p>
<p>Personalized search results for query &#34;sapphire&#34;. User purchased &#34;gemstone&#34;, &#34;crystal&#34;, and &#34;birthstone&#34; items (top). User purchased &#34;necklace&#34; and &#34;jewelry&#34; items (bottom).</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-16.png" src="img/8d8df64fcbe0e897.png"></p>
<p>Results for query &#34;mousepad&#34;. Top user previously purchased &#34;kawaii&#34; and &#34;cute&#34; items; bottom user purchased &#34;monogram&#34; and &#34;family photo&#34; items.</p>
<p>Etsy built a personalized search system via user profile and query representations constructed based on multiple implicit feedback types and various time windows of aggregation. With these features, purchase NDCG@10 and user conversion rates increase overall. Personalization affects users differently, with active users converting at a greater rate due to their richer user history compared to inactive users. The traffic on the mobile application platform generates more personalized results compared to web traffic.</p>
<p>Etsy use an ensemble gradient boosted decision tree with LambdaMART algorithm in the second pass of the information retrieval system. They experiment with two personalized variants in addition to the baseline to track the incremental changes with the addition of new feature groups.</p>
<ul>
<li>Baseline Model contains non-personalized features such as listing dwell time, listing price and number of shop views collected from purchase logs.</li>
<li>P1 Model includes all the baseline model features, plus user profile representations generated from aggregating three types of listing representations: Tf-Idf, item interaction embeddings, and interaction-based graph embeddings.</li>
<li>P2 Model has all the features in the baseline and P1 model, plus query representations engineered to interact with user representations for an even greater number of personalization features.</li>
</ul>
<p>Team measured the degree to which personalization affects different query segments and found that the top 0.01% of head queries generate the lowest similarity of rankings between users, as measured by the Kendall Tau correlation coefficient. For search results pages, there can be a positional biases of the listings. Fairness and inclusivity is an important component of search ranking and recommendations.</p>
<p>For offline evaluation, they look at purchase NDCG@10. For online evaluation, they look at purchase NDCG as well as user conversion rates, user clicks per session and user rates of return. To measure the degree of personalization, they look at Kendall Tau correlation for query bins, platform traffic, and model variants.</p>
<p class="image-container"><img alt="img/_markdowns-raw-recostep-stage-etsy-untitled-17.png" src="img/568ad83e49f31681.png"></p>
<p>Offline evaluations of personalized models P1 and P2 vs Baseline (non personalized), measured by % change in NDCG@10 and degree of personalization in Kendall Tau coefficients. A lower Kendall Tau score means greater degree of personalization.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion" duration="2">
        <p>Congratulations!</p>
<h2 is-upgraded>Links and References</h2>
<ol type="1">
<li><a href="https://arxiv.org/pdf/1812.04407.pdf" target="_blank">https://arxiv.org/pdf/1812.04407.pdf</a></li>
<li><a href="https://youtu.be/UbytXZLqezo?list=PLN7ADELDRRhgecE5dNlvs5ej5UB6ia-dv" target="_blank">Talk presentation YouTube</a></li>
<li><a href="http://public2.brighttalk.com/resource/core/263869/recommendations_in_etsy_sep10_moumitabhattacharya_584550.pdf" target="_blank">PDF of talk presentation</a></li>
<li><a href="https://www.hongliangjie.com/data-science-at-etsy/" target="_blank">https://www.hongliangjie.com/data-science-at-etsy</a></li>
<li><a href="https://www.dsml.etsy.com/publications" target="_blank">https://www.dsml.etsy.com/publications</a></li>
<li><a href="https://youtu.be/jMaa45fw3dQ" target="_blank">Machine Learning as the Key to Personalized Curation - Kamelia Aryafar, Data Scientist, Etsy</a></li>
<li><a href="https://static1.squarespace.com/static/5e239f34ffaab9146caed4c5/t/608c2b1dbe846a30f04b4533/1619798813729/2021_WWW_bandits.pdf" target="_blank">Interpretable Attribute-based Action-aware Bandits for Within-Session Personalization in E-commerce</a></li>
<li><a href="https://static1.squarespace.com/static/5e239f34ffaab9146caed4c5/t/6089d94bb768ba3b81e3c8d5/1619646804980/WWW_21_short_paper_personalized_search.pdf" target="_blank">Personalization in E-commerce Product Search by User-Centric Ranking</a></li>
<li><a href="https://static1.squarespace.com/static/5e239f34ffaab9146caed4c5/t/608c2d4b4201a46976bed4ed/1619799386942/2021_www_perso_poster.pdf" target="_blank">Personalization in E-commerce Product Search by User-Centric Ranking Poster</a></li>
<li><a href="https://www.hongliangjie.com/talks/Etsy_DataScience_Insights.pdf" target="_blank">Machine Learning and Data Science at Etsy</a></li>
</ol>
<h2 is-upgraded>Have a Question?</h2>
<ul>
<li><a href="https://form.jotform.com/211377288388469" target="_blank">Fill out this form</a></li>
<li><a href="https://github.com/recohut/reco-step/issues" target="_blank">Raise issue on Github</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
